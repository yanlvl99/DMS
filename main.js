/**
 @made by yanlvl99
 */
(async()=>{'use strict';class QuestUI{constructor(){this.root=null;this.listContainer=null;this.logContainer=null;this.styleElement=null;this.destroy();this.init()}init(){this.styleElement=document.createElement('style');this.styleElement.textContent=`#quest-overlay-root{position:fixed;top:20px;right:20px;width:320px;background-color:#2b2d31;border-radius:8px;box-shadow:0 8px 16px rgba(0,0,0,0.4);z-index:9999;font-family:'gg sans','Helvetica Neue',Helvetica,Arial,sans-serif;color:#dbdee1;overflow:hidden;border:1px solid #1e1f22}.qo-header{background-color:#1e1f22;padding:12px 16px;font-weight:bold;font-size:14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #111214}.qo-header span{color:#5865F2}.qo-close{cursor:pointer;opacity:0.7;font-size:16px}.qo-close:hover{opacity:1;color:#ed4245}.qo-content{padding:12px;max-height:240px;overflow-y:auto;border-bottom:1px solid #1e1f22}.qo-quest-card{background-color:#313338;border-radius:5px;padding:10px;margin-bottom:10px;border:1px solid #1e1f22}.qo-quest-title{font-size:13px;font-weight:600;margin-bottom:6px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.qo-progress-bg{background-color:#1e1f22;height:8px;border-radius:4px;overflow:hidden;margin-bottom:4px}.qo-progress-fill{height:100%;background-color:#23a559;width:0%;transition:width 0.3s ease}.qo-status-text{font-size:11px;color:#949ba4;display:flex;justify-content:space-between}.qo-console{background-color:#111214;padding:8px;font-family:monospace;font-size:10px;max-height:100px;overflow-y:auto;color:#b5bac1}.qo-log-line{margin-bottom:2px;border-bottom:1px solid #1e1f22;padding-bottom:2px}.qo-log-info{color:#5865F2}.qo-log-success{color:#23a559}.qo-log-warn{color:#f0b232}.qo-log-error{color:#f23f43}#quest-overlay-root ::-webkit-scrollbar{width:8px}#quest-overlay-root ::-webkit-scrollbar-thumb{background:#1a1b1e;border-radius:4px}#quest-overlay-root ::-webkit-scrollbar-track{background:transparent}`;document.head.appendChild(this.styleElement);this.root=document.createElement('div');this.root.id='quest-overlay-root';this.root.innerHTML=`<div class="qo-header"><div><span>Yan's</span> Quest Tools</div><div class="qo-close" id="qo-close-btn">✖</div></div><div class="qo-content" id="qo-quest-list"><div style="text-align:center;color:#555;font-size:12px;padding:10px;">Initializing system...</div></div><div class="qo-console" id="qo-log-console"><div class="qo-log-line">Interface loaded.</div></div>`;document.body.appendChild(this.root);document.getElementById('qo-close-btn').onclick=()=>this.destroy();this.listContainer=document.getElementById('qo-quest-list');this.logContainer=document.getElementById('qo-log-console')}updateQuestCard(id,name,percent,statusText){let card=document.getElementById(`quest-card-${id}`);if(!card){if(this.listContainer.innerText.includes('Initializing')||this.listContainer.innerText.includes('Waiting')){this.listContainer.innerHTML=''}card=document.createElement('div');card.className='qo-quest-card';card.id=`quest-card-${id}`;card.innerHTML=`<span class="qo-quest-title">${name}</span><div class="qo-progress-bg"><div class="qo-progress-fill" style="width: 0%"></div></div><div class="qo-status-text"><span class="qo-status-msg">${statusText}</span><span class="qo-percent">0%</span></div>`;this.listContainer.appendChild(card)}const bar=card.querySelector('.qo-progress-fill');const msg=card.querySelector('.qo-status-msg');const perc=card.querySelector('.qo-percent');const visualPercent=Math.min(100,Math.max(0,percent));bar.style.width=`${visualPercent}%`;msg.innerText=statusText;perc.innerText=`${Math.floor(visualPercent)}%`;if(visualPercent>=100){bar.style.backgroundColor='#5865F2'}}log(msg,type='info'){const line=document.createElement('div');line.className=`qo-log-line qo-log-${type}`;const time=new Date().toLocaleTimeString().split(' ')[0];line.innerText=`[${time}] ${msg}`;this.logContainer.appendChild(line);this.logContainer.scrollTop=this.logContainer.scrollHeight;console.log(`[QuestTool] ${msg}`)}destroy(){const existing=document.getElementById('quest-overlay-root');if(existing)existing.remove();if(this.styleElement)this.styleElement.remove()}}const ui=new QuestUI();async function loadModules(){try{ui.log("Searching for Discord modules...","info");let wpRequire;if(window.webpackChunkdiscord_app){wpRequire=window.webpackChunkdiscord_app.push([[Symbol()],{},r=>r]);window.webpackChunkdiscord_app.pop()}else{throw new Error("Webpack global not found.")}const req=wpRequire.c;const modules={ApplicationStreamingStore:Object.values(req).find(x=>x?.exports?.A?.__proto__?.getStreamerActiveStreamMetadata)?.exports.A,RunningGameStore:Object.values(req).find(x=>x?.exports?.Ay?.getRunningGames)?.exports.Ay,QuestsStore:Object.values(req).find(x=>x?.exports?.A?.__proto__?.getQuest)?.exports.A,FluxDispatcher:Object.values(req).find(x=>x?.exports?.h?.__proto__?.flushWaitQueue)?.exports.h,api:Object.values(req).find(x=>x?.exports?.Bo?.get)?.exports.Bo};for(const[name,module]of Object.entries(modules)){if(!module)throw new Error(`Module ${name} not found.`)}ui.log("Modules loaded successfully!","success");return modules}catch(e){ui.log(`Critical Error: ${e.message}`,"error");console.error(e);return null}}async function run(){const modules=await loadModules();if(!modules)return;const availableQuests=[...modules.QuestsStore.quests.values()].filter(q=>q.userStatus?.enrolledAt&&!q.userStatus?.completedAt&&new Date(q.config.expiresAt).getTime()>Date.now());if(availableQuests.length===0){ui.log("No active quests found.","warn");document.getElementById('qo-quest-list').innerHTML='<div style="text-align:center;color:#f0b232;padding:10px;">No active quests.<br>Check "Discover > Quests" or "User Settings > Gift Inventory".</div>';return}ui.log(`Found ${availableQuests.length} active quests.`,"info");availableQuests.forEach(q=>{ui.updateQuestCard(q.id,q.config.messages.questName,0,"Queued...")});for(const quest of availableQuests){await completeQuest(quest,modules)}ui.log("All quests finished!","success")}async function completeQuest(quest,modules){const{config,userStatus}=quest;const questName=config.messages.questName;const taskConfig=config.taskConfig??config.taskConfigV2;const taskName=Object.keys(taskConfig.tasks)[0];const secondsNeeded=taskConfig.tasks[taskName].target;const secondsDone=userStatus?.progress?.[taskName]?.value??0;const isDesktopApp=typeof window.DiscordNative!=="undefined";ui.log(`Starting: ${questName}`,"info");try{switch(taskName){case"WATCH_VIDEO":case"WATCH_VIDEO_ON_MOBILE":await handleWatchVideo(quest,modules,secondsNeeded,secondsDone);break;case"PLAY_ON_DESKTOP":case"STREAM_ON_DESKTOP":if(!isDesktopApp){ui.log("Desktop App required for this task. Skipping.","error");ui.updateQuestCard(quest.id,questName,0,"Error: App Required");return}await handleGenericDesktopTask(quest,modules,secondsNeeded,secondsDone,taskName);break;default:ui.log(`Unsupported task type: ${taskName}`,"error");ui.updateQuestCard(quest.id,questName,0,"Error: Unsupported");break}}catch(err){ui.log(`Error in quest ${questName}: ${err.message}`,"error")}}async function handleWatchVideo(quest,modules,secondsNeeded,secondsDone){const{id:questId,userStatus,config}=quest;const questName=config.messages.questName;let currentProgress=secondsDone;const enrolledAt=new Date(userStatus.enrolledAt).getTime();while(currentProgress<secondsNeeded){const percent=(currentProgress/secondsNeeded)*100;const minutesLeft=Math.ceil((secondsNeeded-currentProgress)/60);ui.updateQuestCard(questId,questName,percent,`Watching... (~${minutesLeft} min left)`);const maxAllowedProgress=Math.floor((Date.now()-enrolledAt)/1000)+10;const progressStep=5;let newProgress=Math.min(currentProgress+progressStep,maxAllowedProgress,secondsNeeded);if(newProgress>currentProgress){try{const res=await modules.api.post({url:`/quests/${questId}/video-progress`,body:{timestamp:newProgress+Math.random()}});currentProgress=res.body.completed_at?secondsNeeded:newProgress}catch(e){}}await new Promise(r=>setTimeout(r,5000))}ui.updateQuestCard(questId,questName,100,"Completed!");ui.log(`${questName} completed.`,"success")}function handleGenericDesktopTask(quest,modules,secondsNeeded,secondsDone,taskType){return new Promise(async(resolve,reject)=>{const{RunningGameStore,ApplicationStreamingStore,FluxDispatcher,api}=modules;const questName=quest.config.messages.questName;const appId=quest.config.application.id;let fakeGame;let originalGetRunningGames,originalGetGameForPID,originalGetMetadata;try{const pid=Math.floor(Math.random()*30000)+1000;if(taskType==="PLAY_ON_DESKTOP"){const res=await api.get({url:`/applications/public?application_ids=${appId}`});const exeName=res.body[0]?.executables?.find(e=>e.os==="win32")?.name.replace(">","")||"game.exe";const appName=quest.config.application.name;fakeGame={id:appId,pid,name:appName,exeName,cmdLine:`C:\\Fake\\${exeName}`,exePath:`c:/fake/${exeName}`,hidden:false,isLauncher:false,pidPath:[pid],processName:appName,start:Date.now()};const fakeGames=[fakeGame];originalGetRunningGames=RunningGameStore.getRunningGames;originalGetGameForPID=RunningGameStore.getGameForPID;RunningGameStore.getRunningGames=()=>fakeGames;RunningGameStore.getGameForPID=(p)=>fakeGames.find(g=>g.pid===p);FluxDispatcher.dispatch({type:"RUNNING_GAMES_CHANGE",added:fakeGames,games:fakeGames,removed:RunningGameStore.getRunningGames()});ui.log(`Virtual game launched: ${appName}`,"info")}else if(taskType==="STREAM_ON_DESKTOP"){ui.log(`⚠️ ACTION REQUIRED FOR ${questName}!`,"warn");ui.log("1. Join a voice channel.","warn");ui.log("2. Screen share ANY window.","warn");ui.updateQuestCard(quest.id,questName,(secondsDone/secondsNeeded)*100,"Waiting for stream...");originalGetMetadata=ApplicationStreamingStore.getStreamerActiveStreamMetadata;ApplicationStreamingStore.getStreamerActiveStreamMetadata=()=>({id:appId,pid,sourceName:null})}const onHeartbeat=(data)=>{if(data.questId!==quest.id)return;let progress=quest.config.configVersion===1?data.userStatus.streamProgressSeconds:Math.floor(data.userStatus.progress[taskType].value);const percent=(progress/secondsNeeded)*100;const minutesLeft=Math.ceil((secondsNeeded-progress)/60);ui.updateQuestCard(quest.id,questName,percent,`In Progress... (~${minutesLeft} min left)`);if(progress>=secondsNeeded){FluxDispatcher.unsubscribe("QUESTS_SEND_HEARTBEAT_SUCCESS",onHeartbeat);if(taskType==="PLAY_ON_DESKTOP"){RunningGameStore.getRunningGames=originalGetRunningGames;RunningGameStore.getGameForPID=originalGetGameForPID;FluxDispatcher.dispatch({type:"RUNNING_GAMES_CHANGE",removed:[fakeGame],games:[],added:[]})}else{ApplicationStreamingStore.getStreamerActiveStreamMetadata=originalGetMetadata}ui.updateQuestCard(quest.id,questName,100,"Completed!");ui.log(`${questName} completed successfully!`,"success");resolve()}};FluxDispatcher.subscribe("QUESTS_SEND_HEARTBEAT_SUCCESS",onHeartbeat)}catch(e){ui.log(`Task initialization error: ${e.message}`,"error");reject(e)}})}run()})();
